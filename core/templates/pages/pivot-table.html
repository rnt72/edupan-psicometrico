{% extends 'layout-vertical.html' %}

{% load static i18n %}

{% block title %}Tabla de Respuestas{% endblock %}

{% block extra_css %}
<style>
    .text-preview-btn {
        cursor: pointer;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        background: #e8f4fd;
        border: 1px solid #b6d8f2;
        color: #0a58ca;
        font-size: 0.8rem;
        transition: all 0.15s;
    }
    .text-preview-btn:hover {
        background: #cfe2ff;
        border-color: #0d6efd;
    }
    .text-preview-btn iconify-icon {
        flex-shrink: 0;
        font-size: 0.9rem;
    }
</style>
{% endblock extra_css %}

{% block page_content %}

<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="d-flex card-header justify-content-between align-items-center">
                <div>
                    <h4 class="card-title">
                        <iconify-icon icon="solar:table-bold-duotone" class="align-middle text-primary me-1"></iconify-icon>
                        Tabla de Respuestas
                    </h4>
                    <p class="text-muted mb-0">
                        {{ exam.name }} — {{ application.name }}
                        <span class="badge bg-light text-dark ms-2">{{ total_rows }} estudiantes</span>
                        <span class="badge bg-light text-dark">{{ total_columns }} columnas</span>
                    </p>
                </div>
                <a href="{% url 'responses:dashboard' %}" class="btn btn-soft-secondary btn-sm">
                    <iconify-icon icon="solar:arrow-left-broken" class="align-middle me-1 fs-18"></iconify-icon>
                    Volver
                </a>
            </div>

            <!-- Tabla pivot -->
            <div class="card-body">
                {% if rows_data %}
                <div class="table-responsive" style="max-height: 70vh; overflow: auto;">
                    <table class="table table-bordered table-hover table-centered table-sm mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light-subtle" style="position: sticky; top: 0; z-index: 2;">
                            <tr>
                                <th class="text-nowrap" style="position: sticky; left: 0; z-index: 3; background: #f8f9fa; min-width: 140px;">
                                    IDENTIFICACIÓN
                                </th>
                                {% for col in columns %}
                                <th class="text-center text-nowrap px-2">{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows_data %}
                            <tr>
                                <td class="fw-medium text-nowrap" style="position: sticky; left: 0; z-index: 1; background: #fff;">
                                    <code class="text-dark">{{ row.identification }}</code>
                                </td>
                                {% for val in row.values %}
                                <td class="text-center px-2">
                                    {% if val.text %}
                                        {% if val.is_open %}
                                        <span class="text-preview-btn" 
                                              data-bs-toggle="modal" 
                                              data-bs-target="#textModal"
                                              data-text="{{ val.text }}"
                                              title="Ver respuesta completa">
                                            <iconify-icon icon="solar:eye-broken"></iconify-icon>
                                            {{ val.text|truncatechars:15 }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-light text-dark">{{ val.text }}</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <iconify-icon icon="solar:document-broken" class="fs-48 text-muted"></iconify-icon>
                    <p class="text-muted mt-2 mb-0">No hay respuestas registradas en esta aplicación</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver respuesta completa -->
<div class="modal fade" id="textModal" tabindex="-1" aria-labelledby="textModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textModalLabel">
                    <iconify-icon icon="solar:pen-new-square-broken" class="align-middle me-2 text-primary"></iconify-icon>
                    Respuesta Abierta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="p-3 bg-light rounded" style="white-space: pre-wrap; word-break: break-word;" id="textModalContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock page_content %}

{% block extra_javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textModal = document.getElementById('textModal');
    if (textModal) {
        textModal.addEventListener('show.bs.modal', function(event) {
            const trigger = event.relatedTarget;
            const text = trigger.dataset.text || '';
            document.getElementById('textModalContent').textContent = text;
        });
    }
});
</script>
{% endblock extra_javascript %}
